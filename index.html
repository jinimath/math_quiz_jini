<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ê³±ì…ˆê³µì‹ í€´ì¦ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Noto Sans KR',sans-serif;
      background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:20px;
      position:relative;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      width:200%;
      height:200%;
      background-image:
        radial-gradient(circle at 20% 50%, rgba(229, 62, 62, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(56, 189, 248, 0.1) 0%, transparent 50%);
      animation: float 20s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes float{0%,100%{transform:translate(0,0)}50%{transform:translate(30px,-30px)}}

    .container{
      background:rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius:24px;
      box-shadow:0 30px 90px rgba(0,0,0,0.5);
      padding:50px;
      max-width:900px;
      width:100%;
      position:relative;
    }

    .screen{display:none}
    .screen.active{display:block;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

    h1{
      text-align:center;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      margin-bottom:10px;
      font-size:2.5em;
      font-weight:900;
    }
    .subtitle{text-align:center;color:#666;margin-bottom:40px}

    .nickname-input{
      text-align:center;
      padding:40px 0;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
    }
    .nickname-input input{
      width:300px !important;
      min-width:300px !important;
      max-width:300px !important;
      padding:18px !important;
      font-size:1.2em !important;
      border:3px solid #667eea;
      border-radius:12px;
      text-align:center;
      font-weight:700;
      font-family:'Noto Sans KR',sans-serif !important;
    }
    .nickname-input input:focus{
      outline:none;
      border-color:#764ba2;
      box-shadow:0 0 20px rgba(102,126,234,.3);
    }
    .nickname-input button{width:200px;padding:16px 0;box-sizing:border-box}

    .welcome-text{font-size:1.8em;font-weight:900;color:#667eea;margin-bottom:40px;text-align:center}

    .mode-buttons{display:flex;gap:30px;justify-content:center;flex-wrap:wrap}
    .mode-card{
      background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);
      border:3px solid #e9ecef;
      border-radius:20px;
      padding:40px 30px;
      width:280px;
      cursor:pointer;
      transition:all .3s;
    }
    .mode-card:hover{
      transform:translateY(-10px);
      box-shadow:0 20px 50px rgba(102,126,234,.3);
      border-color:#667eea;
    }
    .mode-card.time-attack{border-color:#ef4444}
    .mode-card.time-attack:hover{
      border-color:#ef4444;
      box-shadow:0 20px 50px rgba(239,68,68,.3);
    }
    .mode-icon{font-size:3em;margin-bottom:20px}
    .mode-title{font-size:1.5em;font-weight:900;margin-bottom:15px;color:#1a1a2e}
    .mode-desc{color:#666;line-height:1.6}

    .quiz-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:30px;
      padding:20px;
      background:#f8f9fa;
      border-radius:15px;
    }
    .question-counter{font-size:1.3em;font-weight:900;color:#667eea}
    .timer{
      font-size:2em;
      font-weight:900;
      color:#ef4444;
      font-family:'JetBrains Mono',monospace;
    }
    .timer.warning{animation:pulse .5s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

    .question-area{
      background:linear-gradient(135deg,#f8f9fa 0%,#ffffff 100%);
      padding:40px;
      border-radius:20px;
      margin-bottom:30px;
      min-height:180px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      border:2px solid #e9ecef;
    }
    .question-text{font-size:1.2em;color:#333;margin-bottom:20px;font-weight:700;text-align:center}
    .formula{
      font-family:'JetBrains Mono',monospace;
      color:#1a1a2e;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      padding:0 10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .formula.size-xs{font-size:.9em}
    .formula.size-small{font-size:1.1em}
    .formula.size-medium{font-size:1.3em}
    .formula.size-large{font-size:1.5em}

    input[type="text"]{
      width:110px;
      min-width:80px;
      max-width:160px;
      padding:10px 12px;
      font-size:1em;
      border:3px solid #667eea;
      border-radius:12px;
      text-align:center;
      font-family:'JetBrains Mono',monospace;
      font-weight:700;
    }
    input[type="text"]:focus{
      outline:none;
      border-color:#764ba2;
      box-shadow:0 0 20px rgba(102,126,234,.3);
    }
    input[type="text"].correct{border-color:#10b981;background:#d1fae5}
    input[type="text"].incorrect{border-color:#ef4444;background:#fee2e2}

    .buttons{display:flex;gap:15px;justify-content:center;flex-wrap:wrap}
    button{
      padding:16px 40px;
      font-size:1.1em;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-family:'Noto Sans KR',sans-serif;
      transition:all .3s;
    }
    .btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .btn-primary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 12px 35px rgba(102,126,234,.5)}
    .btn-primary:disabled{opacity:.5;cursor:not-allowed}

    .btn-success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff}
    .btn-success:hover{transform:translateY(-3px)}
    .btn-secondary{background:linear-gradient(135deg,#6b7280 0%,#4b5563 100%);color:#fff}
    .btn-secondary:hover{transform:translateY(-3px)}

    .result-nickname{font-size:1.1em;font-weight:900;text-align:center;color:#1f2937;margin-bottom:10px}
    .result-badge{font-size:3em;text-align:center;margin:10px 0 5px}
    .result-title{font-size:1.5em;font-weight:900;text-align:center;margin-bottom:5px;color:#6b7280}
    .result-score{font-size:2em;font-weight:900;color:#4f46e5;text-align:center;margin-bottom:15px}
    .result-details{
      background:#fde047;
      border-radius:15px;
      padding:20px;
      margin-bottom:20px;
      max-height:520px;
      overflow-y:auto;
    }
    .result-details h3{margin-bottom:15px;color:#374151;font-size:.9em;font-weight:700;text-align:center}
    .result-item{padding:8px 0;border-bottom:none;font-size:.85em;line-height:1.6;color:#1f2937;font-weight:600}
    .result-number{color:#1f2937;font-weight:900}
    .result-question{font-family:'JetBrains Mono',monospace;font-size:.9em;color:#1f2937;display:inline;font-weight:600}
    .result-status{font-weight:900;font-size:1em}
    .result-status.correct{color:#059669}
    .result-status.incorrect{color:#dc2626}

    .logo-container{text-align:center;margin-top:40px;padding-top:30px;border-top:2px solid #e9ecef}
    .logo-text{
      font-size:1.5em;
      font-weight:900;
      background:linear-gradient(135deg,#8b7355 0%,#a0826d 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      letter-spacing:2px;
    }

    /* ìº¡ì²˜ ì „ìš© ì¹´ë“œ */
    #shareStage{
      position:fixed;
      left:-99999px;
      top:0;
      width:760px;
      padding:0;
      background:#fff;
      font-family:'Noto Sans KR',sans-serif;
    }
    .shareCard{
      width:760px;
      background:#fff;
      border-radius:28px;
      overflow:hidden;
      box-shadow:0 0 0 rgba(0,0,0,0);
      border:0;
    }
    .shareTop{
      padding:34px 30px 10px;
      text-align:center;
      background:#ffffff;
    }
    .shareName{
      font-size:42px;
      font-weight:900;
      color:#111827;
      margin-bottom:10px;
      letter-spacing:.2px;
    }
    .shareBadge{
      font-size:52px;
      line-height:1;
      margin:8px 0 6px;
    }
    .shareTitle{
      font-size:56px;
      font-weight:900;
      color:#6b7280;
      margin:8px 0 0;
    }
    .shareScore{
      font-size:88px;
      font-weight:900;
      color:#4f46e5;
      margin:6px 0 18px;
    }
    .shareBox{
      margin:18px 22px 0;
      background:#F9E86A;
      border-radius:26px;
      padding:26px 26px 22px;
    }
    .shareBoxTitle{
      text-align:center;
      font-size:26px;
      font-weight:900;
      color:#374151;
      margin-bottom:18px;
      letter-spacing:.2px;
    }
    .shareRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      font-size:20px;
      line-height:1.85;
      font-weight:700;
      color:#111827;
      padding:6px 0;
    }
    .shareIdx{width:34px;font-weight:900}
    .shareMark{width:26px;font-weight:900}
    .shareMark.ok{color:#10b981}
    .shareMark.no{color:#ef4444}
    .shareText{
      font-family:'JetBrains Mono',monospace;
      font-size:19px;
      font-weight:700;
      color:#111827;
      word-break:break-word;
    }
    .shareFoot{
      height:92px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#eae6df;
      margin-top:18px;
    }
    .shareFootText{
      font-size:52px;
      font-weight:900;
      color:#b7b2ab;
      letter-spacing:2px;
    }

    @media (max-width: 768px){
      .container{padding:30px 20px}
      h1{font-size:2em}
      .mode-buttons{flex-direction:column;align-items:center}
      .mode-card{width:100%}
      .quiz-header{flex-direction:column;gap:15px}
      .question-area{padding:25px 15px}
      .question-text{font-size:1em}
      .formula.size-xs{font-size:.72em;gap:4px}
      .formula.size-small{font-size:.9em;gap:5px}
      .formula.size-medium{font-size:1.05em;gap:6px}
      .formula.size-large{font-size:1.25em}
      input[type="text"]{width:90px;min-width:70px;padding:8px 10px;font-size:.9em}
      button{padding:12px 25px;font-size:.95em}
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ë‹‰ë„¤ì„ ì…ë ¥ -->
    <div id="nicknameScreen" class="screen active">
      <h1>ğŸ§® ê³±ì…ˆê³µì‹ í€´ì¦ˆ</h1>
      <p class="subtitle">AIê°€ ìˆ˜í•™ì ìœ¼ë¡œ ë™ì¹˜ì¸ ë‹µì•ˆì„ ìë™ìœ¼ë¡œ ì¸ì‹í•©ë‹ˆë‹¤</p>

      <div class="nickname-input">
        <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="20" inputmode="text" autocapitalize="off">
        <br>
        <button class="btn-primary" onclick="startGame()">ì‹œì‘í•˜ê¸°</button>
      </div>

      <div class="logo-container">
        <div class="logo-text">ì§€ë‹ˆGOìˆ˜í•™</div>
      </div>
    </div>

    <!-- ëª¨ë“œ ì„ íƒ -->
    <div id="modeScreen" class="screen">
      <h1>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰</h1>
      <p class="welcome-text"><span id="welcomeNickname"></span>ë‹˜</p>

      <div class="mode-buttons">
        <div class="mode-card time-attack" onclick="selectMode('timeAttack')">
          <div class="mode-icon">âš¡</div>
          <div class="mode-title">íƒ€ì„ì–´íƒ</div>
          <div class="mode-desc">
            10ì´ˆ ì•ˆì— ë‹µí•˜ì„¸ìš”!<br>
            ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ë„ì „<br>
            ì´ 10ë¬¸ì œ
          </div>
        </div>

        <div class="mode-card" onclick="selectMode('free')">
          <div class="mode-icon">ğŸ¯</div>
          <div class="mode-title">í”„ë¦¬ ëª¨ë“œ</div>
          <div class="mode-desc">
            ì‹œê°„ ì œí•œ ì—†ì´<br>
            ì²œì²œíˆ ìƒê°í•˜ë©° í’€ê¸°<br>
            ì´ 10ë¬¸ì œ
          </div>
        </div>
      </div>

      <div class="logo-container">
        <div class="logo-text">ì§€ë‹ˆGOìˆ˜í•™</div>
      </div>
    </div>

    <!-- í€´ì¦ˆ -->
    <div id="quizScreen" class="screen">
      <div class="quiz-header">
        <div class="question-counter">
          <span id="currentQuestion">1</span> / 10
        </div>
        <div class="timer" id="timer"></div>
      </div>

      <div class="question-area">
        <div class="question-text">ë‹¤ìŒ ì‹ì˜ ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”</div>
        <div class="formula" id="question"></div>
      </div>

      <div class="buttons">
        <button class="btn-primary" onclick="checkAnswer()" id="checkBtn">ì •ë‹µ í™•ì¸</button>
        <button class="btn-success" onclick="gameMode === 'timeAttack' ? handleTimeAttackAnswer() : nextQuestion()" id="nextBtn" disabled>ë‹¤ìŒ ë¬¸ì œ</button>
      </div>
      <div class="buttons" style="margin-top: 10px;">
        <button class="btn-secondary" onclick="goHome()" id="homeBtn">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
      </div>
    </div>

    <!-- ê²°ê³¼ -->
    <div id="resultScreen" class="screen">
      <div class="result-nickname" id="resultNickname"></div>
      <div class="result-badge" id="resultBadge"></div>
      <div class="result-title" id="resultTitle"></div>
      <div class="result-score"><span id="finalScore"></span> / 10</div>

      <div class="result-details" id="resultDetails"></div>

      <div class="buttons">
        <button class="btn-success" onclick="shareResult()">ğŸ“¤ ê²°ê³¼ ê³µìœ í•˜ê¸°</button>
        <button class="btn-primary" onclick="restartGame()">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
      </div>

      <div class="logo-container">
        <div class="logo-text">ì§€ë‹ˆGOìˆ˜í•™</div>
      </div>
    </div>
  </div>

  <!-- ìº¡ì²˜ ì „ìš©(í™”ë©´ì— ì•ˆ ë³´ì„) -->
  <div id="shareStage" aria-hidden="true">
    <div class="shareCard" id="shareCard">
      <div class="shareTop">
        <div class="shareName" id="shareName">-</div>
        <div class="shareBadge" id="shareBadge">ğŸ‰</div>
        <div class="shareTitle" id="shareTitle">Great!</div>
        <div class="shareScore" id="shareScore">0 / 10</div>
      </div>

      <div class="shareBox">
        <div class="shareBoxTitle">ì •ë‹µ ë‚´ì—­</div>
        <div id="shareList"></div>
      </div>

      <div class="shareFoot">
        <div class="shareFootText">ì§€ë‹ˆGOìˆ˜í•™</div>
      </div>
    </div>
  </div>

  <script>
    // âœ… ìš”ì²­í•˜ì‹  â€œ(a+b+c)^2, (a^3Â±b^3), 3ë³€ìˆ˜ í•­ë“±ì‹/ì¸ìˆ˜ë¶„í•´â€ ê³„ì—´ì„ ëŒ€ëŸ‰ ì¶”ê°€
    const formulas = [
      // (a+b+c)^2, a^2+b^2+c^2 ê´€ë ¨
      { display: ["(a+b+c)Â²", "=", "aÂ²", "+", "bÂ²", "+", "cÂ²", "+", "2ab", "+", "2bc", "+", "blank"], answer: "2ca" },
      { display: ["(a+b+c)Â²", "=", "aÂ²", "+", "bÂ²", "+", "cÂ²", "+", "blank", "+", "2bc", "+", "2ca"], answer: "2ab" },
      { display: ["(a+b+c)Â²", "=", "aÂ²", "+", "bÂ²", "+", "cÂ²", "+", "2ab", "+", "blank", "+", "2ca"], answer: "2bc" },
      { display: ["aÂ²+bÂ²+cÂ²", "=", "(a+b+c)Â²", "-", "blank"], answer: "2(ab+bc+ca)" },
      { display: ["aÂ²+bÂ²+cÂ²", "=", "(a+b+c)Â²", "-", "2ab", "-", "2bc", "-", "blank"], answer: "2ca" },

      // 3ì°¨ ì „ê°œ
      { display: ["(a+b)Â³", "=", "aÂ³", "+", "blank", "+", "3abÂ²", "+", "bÂ³"], answer: "3aÂ²b" },
      { display: ["(a-b)Â³", "=", "aÂ³", "-", "blank", "+", "3abÂ²", "-", "bÂ³"], answer: "3aÂ²b" },
      { display: ["(a-b)Â³", "=", "aÂ³", "-", "3aÂ²b", "+", "blank", "-", "bÂ³"], answer: "3abÂ²" },
      { display: ["(a+b)Â³", "=", "blank", "+", "3aÂ²b", "+", "3abÂ²", "+", "bÂ³"], answer: "aÂ³" },

      // a^3 Â± b^3 ì¸ìˆ˜ë¶„í•´
      { display: ["(a+b)(aÂ²-ab+bÂ²)", "=", "aÂ³", "+", "blank"], answer: "bÂ³" },
      { display: ["(a-b)(aÂ²+ab+bÂ²)", "=", "aÂ³", "-", "blank"], answer: "bÂ³" },
      { display: ["aÂ³+bÂ³", "=", "(a+b)Â³", "-", "3ab", "blank"], answer: "(a+b)" },
      { display: ["aÂ³-bÂ³", "=", "(a-b)Â³", "+", "3ab", "blank"], answer: "(a-b)" },
      { display: ["aÂ³+bÂ³", "=", "(a+b)(aÂ²-ab+bÂ²)", "=", "blank"], answer: "(a+b)Â³-3ab(a+b)" },
      { display: ["aÂ³-bÂ³", "=", "(a-b)(aÂ²+ab+bÂ²)", "=", "blank"], answer: "(a-b)Â³+3ab(a-b)" },

      // (x+a)(x+b)(x+c)
      { display: ["(x+a)(x+b)(x+c)", "=", "xÂ³", "+", "(a+b+c)xÂ²", "+", "blank", "+", "abc"], answer: "(ab+bc+ca)x" },
      { display: ["(x+a)(x+b)(x+c)", "=", "xÂ³", "+", "blank", "+", "(ab+bc+ca)x", "+", "abc"], answer: "(a+b+c)xÂ²" },

      // (a+b+c)(a^2+b^2+c^2-ab-bc-ca)
      { display: ["(a+b+c)(aÂ²+bÂ²+cÂ²-ab-bc-ca)", "=", "aÂ³", "+", "bÂ³", "+", "cÂ³", "-", "blank"], answer: "3abc" },
      { display: ["(a+b+c)(aÂ²+bÂ²+cÂ²-ab-bc-ca)", "=", "blank", "+", "bÂ³", "+", "cÂ³", "-", "3abc"], answer: "aÂ³" },

      // a^3+b^3+c^3 í•­ë“±ì‹
      { display: ["aÂ³+bÂ³+cÂ³", "=", "(a+b+c)(aÂ²+bÂ²+cÂ²-ab-bc-ca)", "+", "blank"], answer: "3abc" },
      { display: ["aÂ³+bÂ³+cÂ³", "=", "blank", "+", "3abc"], answer: "(a+b+c)(aÂ²+bÂ²+cÂ²-ab-bc-ca)" },

      // a^2+b^2+c^2-ab-bc-ca = 1/2(...)
      { display: ["aÂ²+bÂ²+cÂ²-ab-bc-ca", "=", "1/2{(a-b)Â²+(b-c)Â²+", "blank", "}"], answer: "(c-a)Â²" },
      { display: ["aÂ²+bÂ²+cÂ²-ab-bc-ca", "=", "1/2{(a-b)Â²+", "blank", "+(c-a)Â²}"], answer: "(b-c)Â²" },

      // (a^2+ab+b^2)(a^2-ab+b^2)
      { display: ["(aÂ²+ab+bÂ²)(aÂ²-ab+bÂ²)", "=", "aâ´", "+", "aÂ²bÂ²", "+", "blank"], answer: "bâ´" },
      { display: ["(aÂ²+ab+bÂ²)(aÂ²-ab+bÂ²)", "=", "blank", "+", "aÂ²bÂ²", "+", "bâ´"], answer: "aâ´" },

      // ì¶”ê°€ë¡œ ìì£¼ ë‚˜ì˜¤ëŠ” 2ë³€ìˆ˜/ê¸°ë³¸
      { display: ["(x+3)(x+5)", "=", "xÂ²", "+", "blank", "+", "15"], answer: "8x" },
      { display: ["(3x+5)(3x-5)", "=", "blank", "-", "25"], answer: "9xÂ²" },
      { display: ["(5x-2y)Â²", "=", "blank", "-", "20xy", "+", "4yÂ²"], answer: "25xÂ²" },
      { display: ["(2x+3)(3x+4)", "=", "blank", "+", "17x", "+", "12"], answer: "6xÂ²" },
      { display: ["(a+b)Â²", "=", "aÂ²", "+", "blank", "+", "bÂ²"], answer: "2ab" },

      // 3ë³€ìˆ˜ ë³´ì¡° íŒ¨í„´(ìì£¼ ì¶œì œë˜ëŠ” í˜•íƒœ)
      { display: ["ab+bc+ca", "=", "blank"], answer: "( (a+b+c)Â² - (aÂ²+bÂ²+cÂ²) ) / 2" },
      { display: ["aÂ²+bÂ²+cÂ²", "=", "(a+b+c)Â²", "-", "2ab", "-", "2bc", "-", "blank"], answer: "2ca" },
    ];

    let nickname = '';
    let gameMode = '';
    let currentQuestionIndex = 0;
    let questionSet = [];
    let userAnswers = [];
    let timer = null;
    let timeLeft = 10;

    function startGame() {
      nickname = document.getElementById('nicknameInput').value.trim();
      if (!nickname) { alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
      document.getElementById('welcomeNickname').textContent = nickname;
      showScreen('modeScreen');
    }

    function selectMode(mode) {
      gameMode = mode;
      prepareQuiz();
      showScreen('quizScreen');
      displayQuestion();
    }

    function prepareQuiz() {
      // ì¤‘ë³µ ë°©ì§€ ì…”í”Œ
      const shuffled = [...formulas].sort(() => Math.random() - 0.5);
      questionSet = shuffled.slice(0, 10);
      currentQuestionIndex = 0;
      userAnswers = [];
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function displayQuestion() {
      const question = questionSet[currentQuestionIndex];
      const questionDiv = document.getElementById('question');
      questionDiv.innerHTML = '';

      const formulaLength = question.display.join('').length;
      let sizeClass;
      if (formulaLength > 55) sizeClass = 'size-xs';
      else if (formulaLength > 40) sizeClass = 'size-small';
      else if (formulaLength > 28) sizeClass = 'size-medium';
      else sizeClass = 'size-large';
      questionDiv.className = `formula ${sizeClass}`;

      question.display.forEach(part => {
        if (part === 'blank') {
          const input = document.createElement('input');
          input.type = 'text';
          input.id = 'answerInput';
          input.setAttribute('inputmode', 'text');
          input.setAttribute('autocapitalize', 'off');
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              if (gameMode === 'timeAttack') handleTimeAttackAnswer();
              else checkAnswer();
            }
          });
          questionDiv.appendChild(input);
        } else {
          const span = document.createElement('span');
          span.textContent = part;
          questionDiv.appendChild(span);
        }
      });

      document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;

      if (gameMode === 'timeAttack') {
        document.getElementById('checkBtn').style.display = 'none';
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').textContent = 'ë‹¤ìŒ ë¬¸ì œ (Enter)';
      } else {
        document.getElementById('checkBtn').style.display = 'block';
        document.getElementById('checkBtn').disabled = false;
        document.getElementById('nextBtn').disabled = true;
        document.getElementById('nextBtn').textContent = 'ë‹¤ìŒ ë¬¸ì œ';
      }

      document.getElementById('homeBtn').style.display = 'block';

      if (gameMode === 'timeAttack') startTimer();
      else document.getElementById('timer').textContent = '';

      setTimeout(() => {
        const input = document.getElementById('answerInput');
        if (input) input.focus();
      }, 100);
    }

    function startTimer() {
      timeLeft = 10;
      updateTimerDisplay();
      timer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 3) document.getElementById('timer').classList.add('warning');
        if (timeLeft <= 0) { clearInterval(timer); handleTimeAttackAnswer(); }
      }, 1000);
    }

    function updateTimerDisplay() {
      const timerEl = document.getElementById('timer');
      timerEl.textContent = `â±ï¸ ${timeLeft}ì´ˆ`;
      if (timeLeft > 3) timerEl.classList.remove('warning');
    }

    async function checkAnswer() {
      if (timer) clearInterval(timer);

      const input = document.getElementById('answerInput');
      const userAnswer = input.value.trim();
      const correctAnswer = questionSet[currentQuestionIndex].answer;

      if (!userAnswer) {
        alert('ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        if (gameMode === 'timeAttack') startTimer();
        return;
      }

      document.getElementById('checkBtn').disabled = true;

      const isCorrect = await validateWithAI(userAnswer, correctAnswer);

      if (isCorrect) input.classList.add('correct');
      else input.classList.add('incorrect');

      recordAnswer(isCorrect, userAnswer);
      document.getElementById('nextBtn').disabled = false;
    }

    async function handleTimeAttackAnswer() {
      if (timer) clearInterval(timer);

      const input = document.getElementById('answerInput');
      const userAnswer = input.value.trim();
      const correctAnswer = questionSet[currentQuestionIndex].answer;

      const isCorrect = userAnswer ? await validateWithAI(userAnswer, correctAnswer) : false;

      recordAnswer(isCorrect, userAnswer);

      if (currentQuestionIndex < 9) {
        currentQuestionIndex++;
        displayQuestion();
      } else {
        showResults();
      }
    }

    function recordAnswer(isCorrect, userAnswer) {
      userAnswers.push({
        questionParts: questionSet[currentQuestionIndex].display.slice(),
        correctAnswer: questionSet[currentQuestionIndex].answer,
        userAnswer: userAnswer || 'ì‹œê°„ ì´ˆê³¼',
        isCorrect: isCorrect
      });
    }

    function nextQuestion() {
      if (gameMode === 'timeAttack') handleTimeAttackAnswer();
      else {
        if (currentQuestionIndex < 9) { currentQuestionIndex++; displayQuestion(); }
        else showResults();
      }
    }

    function showResults() {
      const correctCount = userAnswers.filter(a => a.isCorrect).length;

      let badge, title;
      if (correctCount === 10) { badge = 'ğŸ†'; title = 'Perfect!'; }
      else if (correctCount >= 8) { badge = 'ğŸ‰'; title = 'Great!'; }
      else if (correctCount >= 5) { badge = 'ğŸ‘'; title = 'Good!'; }
      else { badge = 'ğŸ’ª'; title = 'Cheer up!'; }

      document.getElementById('resultNickname').textContent = `${nickname}ë‹˜`;
      document.getElementById('resultBadge').textContent = badge;
      document.getElementById('resultTitle').textContent = title;
      document.getElementById('finalScore').textContent = correctCount;

      const detailsDiv = document.getElementById('resultDetails');
      detailsDiv.innerHTML = '<h3>ì •ë‹µ ë‚´ì—­</h3>';

      userAnswers.forEach((answer, index) => {
        const parts = answer.questionParts.map(p => p === 'blank' ? answer.userAnswer : p);
        const rendered = parts.join(' ');
        const correctAnswerText = answer.isCorrect ? '' : ` (ì •ë‹µ: ${answer.correctAnswer})`;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'result-item';
        itemDiv.innerHTML = `
          <span class="result-number">${index + 1}.</span>
          <span class="result-status ${answer.isCorrect ? 'correct' : 'incorrect'}">${answer.isCorrect ? 'âœ“' : 'âœ—'}</span>
          <span class="result-question"> ${rendered}${correctAnswerText}</span>
        `;
        detailsDiv.appendChild(itemDiv);
      });

      showScreen('resultScreen');
    }

    async function validateWithAI(userAnswer, correctAnswer) {
      try {
        const normalized1 = normalizeAnswer(userAnswer);
        const normalized2 = normalizeAnswer(correctAnswer);
        if (normalized1 === normalized2) return true;

        // í‚¤ ì—†ì´ í˜¸ì¶œí•˜ë©´ ì‹¤íŒ¨í•©ë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ ì •ê·œí™” ë¹„êµë¡œ íŒì •.
        const prompt = `ë‘ ìˆ˜í•™ì‹ì´ ìˆ˜í•™ì ìœ¼ë¡œ ë™ì¹˜(equivalent)ì¸ì§€ íŒë‹¨í•´ì£¼ì„¸ìš”.

ì‚¬ìš©ì ë‹µë³€: ${userAnswer}
ì •ë‹µ: ${correctAnswer}

ì •í™•íˆ {"equivalent": true} ë˜ëŠ” {"equivalent": false} í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;

        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 300,
            messages: [{ role: "user", content: prompt }],
          })
        });

        if (!response.ok) return normalized1 === normalized2;

        const data = await response.json();
        const text = data.content?.[0]?.text?.trim() || '';
        const jsonMatch = text.match(/\{[^}]+\}/);
        if (jsonMatch) {
          const result = JSON.parse(jsonMatch[0]);
          return result.equivalent === true;
        }
        return false;
      } catch (e) {
        return normalizeAnswer(userAnswer) === normalizeAnswer(correctAnswer);
      }
    }

    function normalizeAnswer(answer) {
      let normalized = String(answer || '').replace(/\s+/g, '').toLowerCase();

      normalized = normalized.replace(/\*/g, '').replace(/Ã—/g, '');
      normalized = normalized.replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')').replace(/\[/g, '(').replace(/\]/g, ')');

      // ì§€ìˆ˜ í‘œê¸° í†µì¼: a^2 -> a2 í˜•íƒœë¡œ ë‹¨ìˆœí™”(í˜„ ë°©ì‹ ìœ ì§€)
      normalized = normalized.replace(/\^/g, '');

      // ìœ ë‹ˆì½”ë“œ ìœ„ì²¨ì ì²˜ë¦¬(Â²,Â³,â´ â†’ 2,3,4)
      normalized = normalized.replace(/Â²/g,'2').replace(/Â³/g,'3').replace(/â´/g,'4');

      // ê¸°í˜¸ ì£¼ë³€ ì •ë¦¬
      normalized = normalized.replace(/\s*\+\s*/g, '+').replace(/\s*-\s*/g, '-');

      // ê³±ì…ˆì˜ êµí™˜ë²•ì¹™ì„ ì™„ì „íˆ ì²˜ë¦¬í•˜ì§„ ì•ŠìŒ(í•„ìš” ì‹œ AI íŒì • ì‚¬ìš©)
      return normalized;
    }

    function buildShareCard() {
      const correctCount = userAnswers.filter(a => a.isCorrect).length;

      let badge, title;
      if (correctCount === 10) { badge = 'ğŸ†'; title = 'Perfect!'; }
      else if (correctCount >= 8) { badge = 'ğŸ‰'; title = 'Great!'; }
      else if (correctCount >= 5) { badge = 'ğŸ‘'; title = 'Good!'; }
      else { badge = 'ğŸ’ª'; title = 'Cheer up!'; }

      document.getElementById('shareName').textContent = `${nickname}ë‹˜`;
      document.getElementById('shareBadge').textContent = badge;
      document.getElementById('shareTitle').textContent = title;
      document.getElementById('shareScore').textContent = `${correctCount} / 10`;

      const list = document.getElementById('shareList');
      list.innerHTML = '';

      userAnswers.forEach((a, i) => {
        const parts = a.questionParts.map(p => p === 'blank' ? a.userAnswer : p);
        const formulaText = parts.join(' ');
        const extra = a.isCorrect ? '' : ` (ì •ë‹µ: ${a.correctAnswer})`;

        const row = document.createElement('div');
        row.className = 'shareRow';
        row.innerHTML = `
          <div class="shareIdx">${i + 1}.</div>
          <div class="shareMark ${a.isCorrect ? 'ok' : 'no'}">${a.isCorrect ? 'âœ“' : 'âœ—'}</div>
          <div class="shareText">${escapeHtml(formulaText + extra)}</div>
        `;
        list.appendChild(row);
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function shareResult() {
      const correctCount = userAnswers.filter(a => a.isCorrect).length;
      const modeText = gameMode === 'timeAttack' ? 'âš¡íƒ€ì„ì–´íƒ' : 'ğŸ¯í”„ë¦¬ëª¨ë“œ';

      buildShareCard();

      const stage = document.getElementById('shareStage');
      stage.style.left = '0px';
      stage.style.top = '0px';
      stage.style.opacity = '1';

      await new Promise(r => setTimeout(r, 80));

      const target = document.getElementById('shareCard');

      try {
        const canvas = await html2canvas(target, {
          backgroundColor: '#ffffff',
          scale: 3,
          useCORS: true,
          logging: false,
          allowTaint: true
        });

        stage.style.left = '-99999px';

        const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1.0));
        if (!blob) { alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }

        const file = new File([blob], `${nickname}_í€´ì¦ˆê²°ê³¼.png`, { type: 'image/png' });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'ì§€ë‹ˆGOìˆ˜í•™ í€´ì¦ˆ ê²°ê³¼',
            text: `${nickname}ë‹˜ì˜ ê²°ê³¼ (${modeText}): ${correctCount}/10`,
            files: [file]
          });
        } else {
          downloadImage(canvas, `${nickname}_í€´ì¦ˆê²°ê³¼.png`);
        }
      } catch (err) {
        stage.style.left = '-99999px';
        console.error('ìº¡ì²˜ ì˜¤ë¥˜:', err);
        alert('ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦°ìƒ·ì„ ì§ì ‘ ì°ì–´ì£¼ì„¸ìš”.');
      }
    }

    function downloadImage(canvas, filename) {
      const url = canvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = filename;
      link.href = url;
      link.click();
      alert('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function restartGame() {
      if (timer) clearInterval(timer);
      document.getElementById('nicknameInput').value = '';
      showScreen('nicknameScreen');
    }

    function goHome() {
      if (timer) clearInterval(timer);
      if (confirm('ê²Œì„ì„ ì¢…ë£Œí•˜ê³  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        document.getElementById('nicknameInput').value = '';
        showScreen('nicknameScreen');
      } else {
        if (gameMode === 'timeAttack') startTimer();
      }
    }

    document.getElementById('nicknameInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startGame();
    });
  </script>
</body>
</html>
